---
import Stack from "../common/Stack.astro";

const WORDS = ["product builder", "runner", "photographer", "problem solver"];
const ENABLE_ANIMATION = true; // Set to false to disable typing animation (words appear instantly)
---

<Stack direction="column" class="iam-container">
  <h2 class="role-title">I'M A</h2>
  <Stack direction="row" alignItems="flex-end">
    <h2 class="role-word" id="role-word">{ENABLE_ANIMATION ? "" : WORDS[0]}</h2>
    <span class="cursor" id="cursor">|</span>
  </Stack>
</Stack>

<style>
  .iam-container {
    flex-grow: 1;
    font-size: clamp(
      var(--font-size-md),
      calc(var(--font-size-md) + 0.1 * (100vw - var(--iam-min-viewport-width))),
      var(--font-size-xl)
    );
  }

  h2 {
    font-size: 1em;
    font-weight: 700;
  }

  .role-word {
    font-weight: 900;
    text-transform: uppercase;
    line-height: 0.9;
  }

  .cursor {
    font-weight: 500;
    font-size: 0.75em;
    animation: none;
    opacity: 1;
    margin-left: 0.1em;
    padding-bottom: 0.1em;
  }

  .cursor.blink {
    animation: blink 1s infinite;
  }

  @keyframes blink {
    0%,
    50% {
      opacity: 1;
    }
    51%,
    100% {
      opacity: 0;
    }
  }
</style>

<script define:vars={{ words: WORDS, enableAnimation: ENABLE_ANIMATION }}>
  const roleWord = document.getElementById("role-word");
  const cursor = document.getElementById("cursor");

  let currentIndex = 0;

  let typingTimeout = null;
  let deletingTimeout = null;
  let waitTimeout = null;

  let rotationInterval = null;

  let isTyping = false;
  let isDeleting = false;

  if (roleWord && enableAnimation) {
    startTyping();
  }

  function startTyping() {
    clearAllTimeouts();
    currentIndex = 0;
    typeWord(words[currentIndex]);
  }

  function clearAllTimeouts() {
    clearTimeout(typingTimeout);
    typingTimeout = null;

    clearTimeout(deletingTimeout);
    deletingTimeout = null;

    clearTimeout(waitTimeout);
    waitTimeout = null;

    clearInterval(rotationInterval);
    rotationInterval = null;
  }

  function typeWord(word, index = 0) {
    if (!roleWord) return;

    isTyping = true;
    isDeleting = false;

    if (cursor) cursor.classList.remove("blink");

    const wordIsNotComplete = index < word.length;
    if (wordIsNotComplete) {
      roleWord.textContent = word.substring(0, index + 1);
      typingTimeout = setTimeout(() => typeWord(word, index + 1), 75);
      return;
    }

    isTyping = false;

    if (cursor) cursor.classList.add("blink");

    waitTimeout = setTimeout(() => {
      deleteWord(word);
    }, 3000);
  }

  function deleteWord(word, index = word.length) {
    if (!roleWord) return;

    isDeleting = true;
    isTyping = false;

    if (cursor) cursor.classList.remove("blink");

    const wordIsNotDeleted = index > 0;
    if (wordIsNotDeleted) {
      roleWord.textContent = word.substring(0, index - 1);
      deletingTimeout = setTimeout(() => deleteWord(word, index - 1), 60);
      return;
    }

    // Deletion complete, move to next word
    isDeleting = false;

    currentIndex = (currentIndex + 1) % words.length;

    typeWord(words[currentIndex]);
  }
</script>
